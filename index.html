<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="GBJSTK.js"></script>
    <title>Notepad</title>
    <script>

/**
 * Add the note to the GB storage when click on + button
 * by the methods
 */
function add_note(){
    gb.storage.getItem("notes", (item) => {
        let notes = item;
        if(!item){
            notes = {};
            gb.storage.setItem("notes", notes);
        } else{
            notes = JSON.parse(notes);
        }
        let date_note = new Date().getTime();
        notes[date_note.toString()] = "";
        gb.storage.setItem("notes", notes);
        gb.location = "editnote?note=" + date_note;
    });
}

/**
 * Triggered by clicking on a note.
 * Recover the id of note and redirect to the page for editing it
 */
function edit_note(event){
    let note = event.currentTarget;
    gb.location = `editnote?note=${note.id}`;
}

/**
 * Format the date for the design
 */
function format_date(date_note){
    let date_array = date_note.toDateString().split(" ");
    let day_name = date_array[0];
    let month_name = date_array[1];
    let day_number = date_array[2];
    let year = date_array[3];
    return month_name + ' ' + day_number + ',' + year;
}

/**
 * Recover all the notes stored in the localstorage and display them
 */
function get_all_notes(){
    gb.storage.getItem("notes", (item)=>{
        if(!item){
            return;
        }
        notes_object = JSON.parse(item);
        keys = Object.keys(notes_object);
        let note_block = document.getElementById('note-block');
        let plus_btn = document.getElementById('plus-btn');
        note_block.replaceChildren();
        note_block.appendChild(plus_btn);
        for (const key of keys) {
            let new_note_container = document.createElement("div");
            let new_note_content = document.createElement("div");
            let new_note_date = document.createElement("div");
            new_note_container.className = "notes";
            new_note_container.id = key;
            new_note_content.className = "note-content";
            new_note_date.className = "note-content-date";
            new_note_content.innerHTML = notes_object[key];
            new_note_date.innerHTML = format_date(new Date(parseInt(key)));
            new_note_container.appendChild(new_note_content);
            new_note_container.appendChild(new_note_date);
            note_block.appendChild(new_note_container);
            new_note_container.addEventListener('click', edit_note);
        }
    })
}

    </script>
</head>
<body>
    <div class="note-container">
        <div class="note-block" id="note-block">
            <div class="button-add-note" onclick="add_note()" id="plus-btn">
                +
            </div>
        </div>
    </div>
</body>
<script>
function gbViewDidAppear()
{
    get_all_notes();
}
gb.onload = get_all_notes();
</script>
</html>